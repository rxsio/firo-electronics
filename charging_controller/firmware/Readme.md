# Charging Controller Firmware

The charging controller communicates over CAN using a single, hard-coded CAN ID. All CAN messages use data frames with one byte dedicated to the message ID, which differentiates various commands and responses. The only exception is the temperature response (0x8B), which includes a second byte containing the actual temperature data. This temperature response can be requested by sending an RTR frame with the charging controller's CAN ID.

| Message                   | Message ID | Description                                                                                                                                                                                                                       |
|---------------------------|------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| CMD Deploy probe          | 0x01       | Requests the controller to deploy the charging probes.                                                                                                                                                                            |
| CMD Attempt charging      | 0x02       | Requests the controller to signal the docking station to start charging.                                                                                                                                                          |
| CMD Stop charging         | 0x03       | Requests the controller to stop charging (cut off batteries).                                                                                                                                                                     |
| CMD Retract probe         | 0x04       | Requests the controller to retract the charging probes.                                                                                                                                                                           |
| RESP Deploy success       | 0x81       | Sent after the deploy hall sensor is activated.                                                                                                                                                                                   |
| RESP Deploy fail          | 0x82       | Sent after a timeout during the deploy sequence if the deploy hall sensor is not activated.                                                                                                                                       |
| RESP Retract success      | 0x83       | Sent after the retract hall sensor is activated.                                                                                                                                                                                  |
| RESP Retract fail         | 0x84       | Sent after a timeout during the retract sequence if the retract hall sensor is not activated.                                                                                                                                     |
| RESP Charging success     | 0x85       | Sent after detecting sufficient current on the charging probes during the charging sequence.                                                                                                                                      |
| RESP Charging fail        | 0x86       | Sent after a timeout during the charging sequence if no current is detected on the charging probes.                                                                                                                               |
| RESP Bus off recovery     | 0x87       | Sent after recovering from a CAN "bus off" error.                                                                                                                                                                                 |
| RESP Overheated           | 0x88       | Sent after measuring a temperature above the safe threshold. (Note: Probes will retract after overheating, and all commands will be ignored.)                                                                                     |
| RESP Overheat recovery    | 0x89       | Sent after the temperature drops below the safe threshold.                                                                                                                                                                        |
| RESP Fatal error recovery | 0x8A       | Sent after a reboot caused by an unhandled error.                                                                                                                                                                                 |
| RESP Status               | 0x8B       | Sent after receiving an RTR message with this device's CAN ID. The second byte encodes the temperature in full degrees (int8_t). Third byte encodes CHARGE_SENSE pin status (0x00 for SENSE_NOT_CHARGING 0xFF for SENSE_CHARGING) |

## Improvements and Considerations

The current protocol has room for improvement. Instead of using the first byte of every message for the message ID, it would be more efficient to use different CAN IDs for each message. For instance, the higher six bits of the CAN ID could represent the device ID, while the lower five bits could represent the message ID.

Additionally, it would be beneficial to adopt a standardized configuration format for defining CAN messages rather than hard-coding them.

Currently, CAN packet losses are not detected or handled. The existing CAN ACK is insufficient because it only confirms that the frame was received by any device, not necessarily the intended recipient. There is no mechanism to manually acknowledge receipt or to request the current state of the charging station. A potential workaround could involve adding flags and CAN messages to request and respond with the current state of the charging controller.

Finally, implementing a robust state machine to manage transitions from probe deployment to charging and then to probe retraction would enhance reliability. This would reduce the risk of introducing new bugs when extending or modifying the current code.